---
title: "mashr with common baseline"
author: "Yuxin Zou"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{mashcommonbaseline intro}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,comment = "#",fig.width = 5,
                      fig.height = 4,fig.align = "center",
                      eval = TRUE)
```

# Introduction

We want to estimate the change in some quantity computed in multiple conditions over a **common** reference level. We must consider the additional burden of comparing all subsequent conditions to the same reference level. Failure to deal with such correlations induces many false positives in a mashr analysis. 

To deal with these correlations, mashr allows the user to specify a contrast matrix L using `mash_set_data_contrast`, after setting up the data in `mash_set_data`. 

# Illustration

Here we simulate data for illustration. It has 8 conditions, the first one is the reference level. Our goal is to estimate the deviations in the rest 7 conditions over the reference level.

```{r}
library(mashr)
set.seed(1)
simdata = sim_contrast2(nsamp = 12000, ncond = 8)
```

Read in the data, and specify the contrast matrix L
```{r}
orig.data = mash_set_data(simdata$Chat, simdata$Shat)

R = 8
L = diag(R-1)
L = cbind(rep(-1, R-1), L)
row.names(L) = c('2-1','3-1','4-1','5-1','6-1','7-1','8-1')

data.L = mash_set_data_contrast(orig.data, L)
data = mash_set_data(data.L$Bhat, data.L$Shat)
```

Now we have two mash data objects, one (data.L) with the induced correlation, and one without (data). `mash_set_data_contrast` computes the deviations defined by `L` internally, and accounts for the induced correlation.

We proceed the analysis using just the simple canonical covariances as in the [initial introductory](intro_mash.html) vignette.

```{r}
U.c = cov_canonical(data.L)
mashcontrast.model = mash(data.L, U.c, algorithm.version = 'R')
```

```{r}
print(get_loglik(mashcontrast.model),digits=10)
```

Use `get_significant_results` to find the indices of effects that are 'significant':
```{r}
length(get_significant_results(mashcontrast.model))
```

The number of false positive is `r sum(get_significant_results(mashcontrast.model) < 12000-1200)`.

We can also compare the model without the induced correlation.
```{r}
m = mash(data, U.c)
```
```{r}
print(get_loglik(m),digits = 10)
```

The model from `data.L` has higher likelihood, since it considers the induced correlation. 

Without considering the induced correlation, there are `r length(get_significant_results(m))` significant effects, `r sum(get_significant_results(m) < 12000-1200)` of them are false positives.





